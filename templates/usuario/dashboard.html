{% extends "base.html" %}
{% block title %}Meu painel – Coopbras{% endblock %}

{% block head_extra %}
<style>
  .kpi-card{ border:none; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.07); }
  .kpi-header{ font-size:.9rem; color:var(--bronze); }
  .kpi-value{ font-size:1.75rem; font-weight:800; color:var(--verde); }
  .perfil-card .label{ color:var(--bronze); font-size:.9rem; }
  .progress-ouro{ background:#e9e2cf; height:10px; border-radius:8px; overflow:hidden; }
  .progress-ouro > div{ height:100%; background:linear-gradient(135deg, var(--ouro), #f1d289); }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- cabeçalho -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Olá, {{ u.nome }}</h2>
      <div class="text-muted">Matrícula: {{ u.matricula }} • {{ u.email }}</div>
    </div>
    <a href="#" class="btn btn-sm btn-outline-dark" style="border-color:var(--ouro); color:var(--bronze);">Editar perfil</a>
  </div>

  <!-- perfil / conformidade -->
  <div class="row g-3 mb-2">
    <div class="col-lg-4">
      <div class="card perfil-card p-3 kpi-card h-100">
        <h5 class="mb-3">Perfil</h5>
        <div class="label">Nível</div>
        <div class="fw-semibold mb-2">{{ u.nivel }}</div>

        <div class="label">Cotas</div>
        <div class="fw-semibold mb-2">{{ u.cotas }}</div>

        <div class="label">Saldo disponível</div>
        <div class="fw-semibold mb-2">R$ {{ '%.2f'|format(u.saldo_disponivel) }}</div>

        <div class="label mb-1">Conformidade</div>
        <div class="progress-ouro mb-1"><div style="width: {{ (u.status_conformidade*100)|round(0) }}%"></div></div>
        <small class="text-muted">{{ (u.status_conformidade*100)|round(0) }}% completo</small>
      </div>
    </div>

    <!-- KPIs -->
    <div class="col-lg-8">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card kpi-card p-3 h-100">
            <div class="kpi-header">Ouro nas últimas operações</div>
            <div class="kpi-value">{{ '%.1f'|format(kpis.min_ultimas_operacoes) }} kg</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card kpi-card p-3 h-100">
            <div class="kpi-header">Pendências</div>
            <div class="kpi-value">{{ kpis.documentos_pendentes }}</div>
            <small class="text-muted">documentos</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card kpi-card p-3 h-100">
            <div class="kpi-header">Ordens</div>
            <div class="kpi-value">{{ kpis.ordens_em_andamento }}</div>
            <small class="text-muted">em andamento</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card kpi-card p-3 h-100">
            <div class="kpi-header">Benefícios</div>
            <div class="kpi-value">{{ kpis.beneficios_disponiveis }}</div>
            <small class="text-muted">ativos</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- gráfico + atividades -->
  <div class="row g-3 mt-1">
    <div class="col-lg-7">
      <div class="card p-3 kpi-card h-100">
        <h5 class="mb-3">Evolução do saldo</h5>
        <canvas id="saldoChart" height="140"></canvas>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card p-3 kpi-card h-100">
        <h5 class="mb-3">Atividades recentes</h5>
        <ul class="list-group list-group-flush">
          {% for a in atividades %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ a.titulo }}</div>
              <div class="small text-muted">{{ a.detalhe }}</div>
            </div>
            <span class="badge rounded-pill" style="background:var(--verde); color:#fff;">{{ a.data }}</span>
          </li>
          {% endfor %}
        </ul>
        <a href="#" class="btn btn-sm btn-outline-dark mt-3" style="border-color:var(--ouro); color:var(--bronze);">Ver mais</a>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const ctx = document.getElementById('saldoChart');
  const saldoChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ series.labels|tojson }},
      datasets: [{
        label: 'Saldo (R$)',
        data: {{ series.saldo|tojson }},
        tension: 0.35,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display:false } },
        y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,.06)' } }
      }
    }
  });
</script>
{% endblock %}
